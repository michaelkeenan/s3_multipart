!function(t){t.S3MP=function(){function e(e){var r,s=[],i=this;_.extend(this,e),this.headers=_.object(_.map(e.headers,function(t,e){return["x-amz-"+e.toLowerCase(),t]})),this.uploadList=[],this.handler={beginUpload:function(){function t(t,n){{var r=n.key;n.parts.length}"undefined"==typeof e[r]&&(e[r]=0),e[r]++;for(var s=0;t>s;s++)n.parts[s].activate();i.handler.startProgressTimer(r),i.onStart(n)}var e=[];return t}(),onError:function(){},onPartSuccess:function(t,e){var n,r,s;n=t.parts,e.status="complete",s=e.xhr.getResponseHeader("ETag"),t.Etags.push({ETag:s.replace(/\"/g,""),partNum:e.num}),t.uploaded+=e.size,t.inprogress[e.num]=0,r=_.indexOf(n,e),n.splice(r,1),n.length&&(r=_.findIndex(n,function(t){return"active"!==t.status?!0:void 0}),-1!==r&&n[r].activate()),n.length||this.onComplete(t)},onComplete:function(t){var e=_.indexOf(i.uploadList,t);this.clearProgressTimer(e),i.completeMultipart(t,function(e){e.location&&i.onComplete(t)})},onProgress:function(t,e,n,r,s){i.onProgress(t,e,n,r,s)},startProgressTimer:function(){var e=[],n=function(n){s[n]=t.setInterval(function(){var t,r,s,o,a;"undefined"==typeof e[n]&&(e[n]=0),t=i.uploadList[n],r=t.size,s=t.uploaded,_.each(t.inprogress,function(t){isNaN(t)||(s+=t)}),o=s/r*100,o=(t.num_parts-t.parts.length)/t.num_parts*100;var u=s/r*100,p=100/t.num_parts;p>o&&(o=p>u?u:p),a=s-e[n],e[n]=s,t.handler.onProgress(n,r,s,o,a)},1e3)};return n}(),clearProgressTimer:function(e){t.clearInterval(s[e])}},r=this.fileSelector?$(this.fileSelector).get(0).files:this.fileList,_.each(r,function(t,e){var r=new n(t,i,e);i.uploadList.push(r),r.init()})}function n(t,e,n){function s(){var e,s,i,o,a;e=this,this.key=n,this.file=t,this.name=t.name.replace(/[^a-z.A-Z0-9\-_]+/g,"_").replace("_.",".").replace(/^_/,""),this.size=t.size,this.type=t.type,this.Etags=[],this.inprogress=[],this.uploaded=0,this.status="",this.size>1e9?(num_segs=100,o=10):this.size>5e8?(num_segs=50,o=5):this.size>104857600?(num_segs=20,o=5):this.size>5e7?(num_segs=5,o=2):this.size>10485760?(num_segs=2,o=2):(num_segs=1,o=1),s=_.range(num_segs+1),i=_.map(s,function(e){return Math.round(e*(t.size/num_segs))}),"Unsupported"==e.sliceBlob?this.parts=[new r(t,0,e)]:(this.parts=_.map(i,function(n,s){return a=e.sliceBlob(t,n,i[s+1]),new r(a,s+1,e)}),this.parts.pop()),this.num_parts=this.parts.length,this.init=function(){e.initiateMultipart(e,function(t){e.id=t.id,e.upload_id=t.upload_id,e.object_name=t.key,e.parts;e.handler.beginUpload(o,e)})}}return s.prototype=e,new s}function r(t,e,n){var r,s;r=this,this.size=t.size,this.blob=t,this.num=e,this.upload=n,this.xhr=s=n.createXhrRequest(),s.onload=function(){n.handler.onPartSuccess(n,r)},s.onerror=function(){n.handler.onError(n,r)},s.upload.onprogress=_.throttle(function(t){t.lengthComputable&&(n.inprogress[e]=t.loaded)},1e3)}return _.mixin({findIndex:function(t,e){for(var n=0;n<t.length;n++)if(e(t[n],n,t))return n;return-1}}),e.prototype.initiateMultipart=function(t,e){var n,r,s;n="/s3_multipart/uploads",r=JSON.stringify({object_name:t.name,content_type:t.type,content_size:t.size,headers:this.headers,context:$(this.fileInputElement).data("context"),uploader:$(this.fileInputElement).data("uploader")}),s=this.createXhrRequest("POST",n),this.deliverRequest(s,r,e)},e.prototype.signPartRequests=function(t,e,n,r,s){var i,o,a,u;i=_.reduce(_.rest(r),function(t,e){return t+"-"+e.size},r[0].size),o="/s3_multipart/uploads/"+t,a=JSON.stringify({object_name:e,upload_id:n,content_lengths:i}),u=this.createXhrRequest("PUT",o),this.deliverRequest(u,a,s)},e.prototype.signPartRequest=function(t,e,n,r,s){var i,o,a,u;i=r.size,o="/s3_multipart/uploads/"+t,a=JSON.stringify({object_name:e,upload_id:n,content_length:i,part_number:r.num}),u=this.createXhrRequest("PUT",o),this.deliverRequest(u,a,s)},e.prototype.completeMultipart=function(t,e){for(var n,r,s,i=3;;)try{return n="/s3_multipart/uploads/"+t.id,r=JSON.stringify({object_name:t.object_name,upload_id:t.upload_id,content_length:t.size,parts:t.Etags}),s=this.createXhrRequest("PUT",n),void this.deliverRequest(s,r,e)}catch(o){if(--i<1)throw o}},e.prototype.deliverRequest=function(t,e,n){var r=this;t.onload=function(){return response=JSON.parse(this.responseText),response.error?r.onError({name:"ServerResponse",message:response.error}):void n(response)},t.onerror=function(){console.log("Error occurred")},t.setRequestHeader("Content-Type","application/json"),t.setRequestHeader("X-CSRF-Token",$('meta[name="csrf-token"]').attr("content")),t.send(e)},e.prototype.createXhrRequest=function(){var t;return t="function"==typeof XMLHttpRequest.constructor?XMLHttpRequest:"undefined"!=typeof XDomainRequest?XDomainRequest:null,function(e,n,r,s){var i,o,s=!0;return i=Array.prototype.slice.call(arguments),"undefined"==typeof i[0]&&(r=null,s=!1),o=new t,s&&o.open(e,n,!0),o.onreadystatechange=r,o}}(),e.prototype.sliceBlob=function(){try{var t=new Blob}catch(e){return"Unsupported"}return t.slice?function(t,e,n){return t.slice(e,n)}:t.mozSlice?function(t,e,n){return t.mozSlice(e,n)}:t.webkitSlice?function(t,e,n){return t.webkitSlice(e,n)}:"Unsupported"}(),e.prototype._returnUploadObj=function(t){var e=_.find(this.uploadList,function(e){return e.key===t});return e},e.prototype.cancel=function(t){var e,n;e=this._returnUploadObj(t),n=_.indexOf(this.uploadList,e),this.uploadList.splice(n,n+1),this.onCancel()},e.prototype.pause=function(t){var e=this._returnUploadObj(t);_.each(e.parts,function(t){"active"==t.status&&t.pause()}),this.onPause()},e.prototype.resume=function(t){var e=this._returnUploadObj(t);_.each(e.parts,function(t){"paused"==t.status&&t.activate()}),this.onResume()},r.prototype.activate=function(){var t=this;this.upload.signPartRequest(this.upload.id,this.upload.object_name,this.upload.upload_id,this,function(e){t.xhr.open("PUT","//"+t.upload.bucket+".s3.amazonaws.com/"+t.upload.object_name+"?partNumber="+t.num+"&uploadId="+t.upload.upload_id,!0),t.xhr.setRequestHeader("x-amz-date",e.date),t.xhr.setRequestHeader("Authorization",e.authorization),t.xhr.send(t.blob),t.status="active"})},r.prototype.pause=function(){this.xhr.abort(),this.status="paused"},e}()}(this);